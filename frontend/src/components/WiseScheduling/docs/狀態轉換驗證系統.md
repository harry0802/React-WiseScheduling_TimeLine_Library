# 狀態轉換驗證系統

本文件說明WiseScheduling系統中的狀態轉換驗證機制，包括各層級驗證和安全保障。

## 驗證層級

系統實施了多層驗證，確保資料一致性和業務規則的嚴格執行：

### 1. UI層驗證

在用戶界面層面，系統提供了視覺和交互方面的驗證：

- **視覺反饋**：在StatusChangeDialog中，不合法的狀態轉換選項會被禁用，並顯示"無法切換到此狀態"提示
- **模式限制**：添加模式下不顯示狀態切換按鈕，僅在編輯模式下允許狀態切換
- **提示信息**：非待機狀態下顯示"注意：當前狀態只能切換回待機狀態"的提示

### 2. 前端業務邏輯驗證 

在組件內部實施了多重業務邏輯驗證：

- **handleStatusChange**：狀態切換時調用validateStatusTransition函數驗證
- **handleSubmit**：表單提交前再次驗證狀態轉換合法性
- **時間重疊檢查**：確保非製令單狀態間不發生時間重疊
- **自動終止時間**：非待機狀態切換到待機狀態時，自動設置結束時間

### 3. API請求層驗證

在資料轉換為API格式前進行更嚴格的驗證：

- **validateApiStatusTransition**：API轉換前驗證狀態轉換的合法性
- **validateApiItemCompleteness**：驗證API資料的完整性和必填字段
- **專用轉換函數**：提供transformNewStatusToApi和transformUpdateStatusToApi等專用函數，對不同場景進行精確驗證

## 核心業務規則

系統嚴格執行以下核心業務規則：

1. **製令單不可轉換**：製令單狀態不能被切換到其他狀態
2. **待機狀態可自由轉換**：待機狀態可以切換到任何狀態
3. **非待機只能回待機**：非待機狀態只能切換回待機狀態
4. **狀態時間記錄**：狀態轉換時自動記錄相應的時間戳
5. **時間重疊限制**：除製令單外的狀態不允許時間重疊

## 實現細節

- **統一的驗證邏輯**：所有驗證邏輯集中在statusHelpers.js和apiValidators.js中
- **模式感知**：驗證函數根據不同模式(add/edit/view)實施不同程度的驗證
- **豐富的錯誤提示**：每種驗證失敗都有明確的錯誤信息
- **邏輯分離**：UI顯示邏輯和業務驗證邏輯分離

## 開發指南

新功能開發時，請確保遵循以下原則：

1. 新增的狀態轉換邏輯必須在多層級驗證中同步更新
2. 使用validateStatusTransition函數驗證狀態轉換
3. 修改狀態轉換規則時，必須更新constants.js中的配置
4. 添加新狀態時，確保在MACHINE_STATUS和STATUS_CONFIG中定義
5. 測試時需確認所有驗證層級是否協同工作

## 故障排除

常見問題及解決方案：

- **狀態轉換被阻止**：檢查validateStatusTransition函數的錯誤消息
- **提交失敗**：查看控制台錯誤，可能是API驗證失敗
- **時間重疊錯誤**：確保非製令單狀態之間沒有時間重疊
- **無法選擇狀態**：檢查canChangeStatus函數的返回值

---

最後更新：2025年5月16日
